# Reference
This document list all API functionality and guide you on how to use the classes offered by Steer.

# Contents
- [What is Steer](#what-is-steer)
- [The guide](#the-guide)
    - [Dependencies](#dependencies)
- [Packages](#packages)

# What is Steer
Steer is URL creator for OAuth2 and Drive for Google APIs as mentioned [here](https://github.com/fernando-gap/steer#steer). Steer **does not**: make a **HTTP request**, create other types of OAuth2 URLs other than *Desktop & Mobile Apps*. The document is where methods and classes will be teaching you in how to use them.

# The Guide
This is a guide throughout the api reference, each method and class will be explained and used in a interactive example and in the end you will have an app built with the steer API. To follow the example while reading this document it is recomended that you install the dependencies below. 

## Dependencies
If you want to follow the example with steer it is needed to install some dependencies first. These are python, flask, requests and pip.

It is assumed that you already have pip and python, if not install it and comeback later :). to Install *flask* and *requests* do the following:
```
$ pip install flask
$ pip install requests
```
## The Application Example
The example that will be used in this guide **do not interfere** if you don't follow.

The app purpose is simple: each time the user executes the app a file is written in its Drive, the user can pass arguments to revoke the access, and update a file, also the application should be refreshing the token to avoid the user do the OAuth2 screen again.

The example is used inside a [project of google](https://developers.google.com/workspace/guides/create-project) it is assumed that you already have a project and the API keys to get started. 

# Packages
The Steer API has two packages oauth and drive which provides useful modules to handle Google API URLs.

To import the main packages:
```python
import steer.oauth.api as oauth
import steer.drive.upload as drive
```

where oauth is where the module of OAuth2 is provided (i. e. OAuth2 classes) and drive where will contain the drive upload methods and classes.

Steer also provides some extra modules to use OAuth2 that is:
```python
import steer.oauth.challenge as challenge
import steer.oauth.response as response
```

Where challenge is the *code_challenge* generated by you and used by Google to increase the security levels of a desktop app, Steer provides full support to this. 

The response module is to handle the response after the code exchange. It has two purposes: to get the *refresh_token* and *access_token* and to check whether the access_token is expired after some time (time given by google).

# OAuth2
The module of OAuth2 is where all the URL creation process happens. It should be enough to create an application.

## OAuth2 class
Before dive in the OAuth2 is necessary to understand how google uses it, and which type of fields is needed. To create the OAuth2 URL is necessary the following fields of authentication provided by google or you:

- client_id
- scope
- response_type
- redirect_uri
- client_secret

The class OAuth2 can load these necessary config to create the OAuth2 URLs, it can be provided a *json*, a *dictionary*, or passing *keywords* arguments to the instance.

config.json
```json
{
    "client_id": "your_client_id",
    "scope": "authorization_scope",
    "response_type": "code",
    "redirect_uri": "http://localhost:port"
}
```
The *redirect_uri* is the Loopback IP address which is provided by you in the moment of the URL creation.
The *response_type* for **desktop** it defaults to code, however, in the future Steer will support different types of authentication.

A instance of OAuth2 can load three types of configuration:
```python
# json
auth = OAuth2(json_path="./config.json")

# dictionary
config = {
    "client_id": "your_client_id",
    "scope": "authorization_scope",
    "response_type": "code",
    "redirect_uri": "http://localhost:port"
}

auth = OAuth2(dict_params="./config.json")

# keyword arguments
auth = OAuth2(client_id="your_client_id",
              scope="authorization_scope",
              response_type="code",
              redirect_uri="http://localhost:port"
              )
```

The example application uses the `config.json` as configuration. 

## OAuth2 Methods
### OAuth2.create(challenge=None)
The create method is the *first* thing you invoke if you want to authenticate the user, it creates the URL for your application. The create method do not need any arguments. The method return the respective URL if you want to store in a variable.

Arguments:
- challenge - The challenge is a `code_challenge` created for every request, and sent to the authorization url to get the access token. Steer provides a class to create URL with this type of request. More in **<code_challenge_section>**

#### Example
The first thing in our example is to add the OAuth2 authentication and create an OAuth2 URL.

```python
# app.py
from steer.oauth.api import OAuth2

oauth = OAuth2(json_path='./config.json')
oauth.create()
```

### OAuth2.open()
Google do not let you open this request using a *http client* because this URL opens a user consent screen of Google. This method does exactly this it opens the default user's browser to start the OAuth2.

#### Example
Open the default browser of the client in our example.
```python
oauth.open()
```

The user should authorize the application to access its drive. When this happen the Google server sends an authorization code from our Loopback IP address as described [here](#the-redirect_uri) the link is a continuation of our app example.

### OAuth2.accesstoken(code, secret=None)
The code received is needed to use in the code exchange which is the second thing you needed to do after you send the last request that is when you call `OAuth2.create()`.

Arguments:
- code - The code is given by Google after the user gives access to the application
- secret - the client_secret (optional)

#### Example
To exchange the code for an *access_token* and a *refresh_token*
```python
code_url = oauth.accesstoken(code)
```

After the code exchange is ready it is necessary to create a `POST` request to obtain the `access_token` and `refresh_token`.
At the end of the file put this.
```python
import requests

response = requests.post(code_url)
tokens = response.json()
```
The `tokens` is a response in json format including the `access_token`, `refresh_token`, and `expires_in` properties. To keep going with the example continue here. <link> 

# The redirect_uri
The redirect URI is where Google send the authorization code, we will be using the Loopback IP address.

### Example
After the `oauth.open()` is performed, the user should authorize the application to access the user's Drive. If the user authorizes then the Google should send the authorization token to where your server is listening to.

The implementation of this is a simple flask instance used with some [coroutines](https://realpython.com/async-io-python/) functions.

This is the **continuation of our app** example:
```python
# app.py
from flask import Flask, request, redirect
from steer.oauth.api import OAuth2

from os import kill, getpid
from signal import SIGINT
import asyncio

code_url = ''

async def server():
    app = Flask(__name__)

    @app.route('/')
    def oauth_code():
        code = request.args.get('code')
        code_url = oauth.accesstoken(code)
        return redirect('/exit')

    @app.route('/exit')
    def exit():
        kill(getpid(), SIGINT)
        return ""

    return

oauth = OAuth2(json_path='./config.json')
oauth.create()
oauth.open()
asyncio.run(server())

```

At this stage the file should look like above.

The first thing added to our app it was the OAuth2 URL, that enables the user to login in. The second is a server implemented in Flask which is a coroutine that awaits a request from Google, after a request is received the authorization code is stored as `code`, and the code exchange URL is made by [`OAuth2.accesstoken()`](#oauth2accesstokencode-secretnone). At the end the server is closed by killing the process with `kill`.

To continue with the example click [here](#oauth2accesstokencode-secretnone)
