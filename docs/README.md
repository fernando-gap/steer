# Reference
<a href="https://github.com/fernando-gap/steer/blob/main/docs/pt-br/README.pt-br.md">
  <img src="https://img.shields.io/badge/lang-pt--br-green">
</a>

This document list all API reference and guide you on how to use Steer. To follow the guide to create your first app click [here](https://github.com/fernando-gap/steer/blob/main/docs/EXAMPLE-APP.md).

# Contents
- [What is Steer](#what-is-steer)
- [Packages](#packages)
- [OAuth2](#oauth2)
    - [OAuth2 Class](#oauth2-class)
        - [create](#oauth2createchallengenone)
        - [open](#oauth2open)
        - [accesstoken](#oauth2accesstokencode-secretnone)
        - [revokeaccess](#oauth2revokeaccesstoken)
        - [refreshtokens](#oauth2refreshtokensrefresh_token--secret)
    - [Challenge Class](#challenge-class)
    - [OAuth2Response Class](#oauth2response-class) 
- [Drive](#drive)
    - [Upload Class](#upload-class)
        - [simple](#uploadsimplemedia--none)
        - [multipart](#uploadmultipartfile--none-metadata--none)

# What is Steer
Steer is a URL creator for OAuth2 and Drive for Google APIs as mentioned [here](https://github.com/fernando-gap/steer#steer). What Steer **does not** actually do is make a **HTTP request**, and create other types of OAuth2 URLs other than *Desktop & Mobile Apps*.

# Packages
The Steer API has two packages oauth and drive which provides useful modules to create Google API URLs.

To import the main packages:
```python
import steer.oauth.api as oauth
import steer.drive.upload as drive
```

Where oauth is the package, and the class OAuth2 is provided by the `api` module. The Drive package contains the drive modules.

Steer also provides some extra modules to use with OAuth2 that is:
```python
import steer.oauth.challenge as challenge
import steer.oauth.response as response
```

Where challenge is the `code_challenge` generated by you and used by Google to increase the security levels of a desktop app, Steer provides full support to this. 

The response module is to handle the response after the code exchange. It has two purposes: to get the `refresh_token` and `access_token` and to check whether the `access_token` is expired after some time i. e. given by google.

# OAuth2
The module of OAuth2 is where all the URL creation process happens. It should be enough to create an application.

## OAuth2 Class
Before dive in the OAuth2 is necessary to understand how google uses it, and which type of fields is needed to create the OAuth2 URL. The following fields of authentication is noticeable:

- client_id
- scope
- response_type
- redirect_uri
- client_secret

The class OAuth2 can load these fields using a *json*, a *dictionary*, or passing *keywords* arguments to the instance.

config.json
```json
{
    "client_id": "your_client_id",
    "scope": "authorization_scope",
    "response_type": "code",
    "redirect_uri": "http://localhost:port"
}
```
The `redirect_uri` is the Loopback IP address which is provided by you in the moment of the URL creation.
The `response_type` for **desktop** is set up for `code`, Steer only supports authentication for *Desktop apps*.

```python
# json
auth = OAuth2(json_path="./config.json")

# dictionary
config = {
    "client_id": "your_client_id",
    "scope": "authorization_scope",
    "response_type": "code",
    "redirect_uri": "http://localhost:port"
}

auth = OAuth2(dict_params="./config.json")

# keyword arguments
auth = OAuth2(client_id="your_client_id",
              scope="authorization_scope",
              response_type="code",
              redirect_uri="http://localhost:port"
              )
```

## OAuth2 Methods
### OAuth2.create(challenge=None)
The `create` method is the **first** thing you invoke if you want to authenticate the user, it creates the OAuth2 URL for your application. The method can optionally uses a `code_challenge`. The method return the respective URL if you want to store in a variable.

Arguments:
- challenge - The challenge is a `code_challenge` created for every request, and sent to the authorization url to get the access token.

#### Example
Create an OAuth2 instance and create the OAuth2 URL.

```python
# app.py
from steer.oauth.api import OAuth2

oauth = OAuth2(json_path='./config.json')
oauth.create()
```

### OAuth2.open()
Google does not let you open the request using a *http client*. The method opens the default user's browser to start the OAuth2 request, the only part of steer that *actually* sends a *request*.

```python
oauth.open()
```

The user should authorize the application to access its drive to tell Google to send the authorization code to the `Loopback IP address`.

<!-- OAuth2 package continuation -->
### OAuth2.accesstoken(code, secret=None)
The code received is needed to use in the code exchange which is the second thing to do to get the access token.

Arguments:
- code - The code is given by Google after the user passes the consent screen
- secret - the client_secret (optional if you use in 'config.json')

#### Example
To create a code exchange URL.
```python
code_url = oauth.accesstoken(code)
```

### OAuth2.revokeaccess(\*\*token)
To revoke the access rights of your application.

Arguments:
- tokens - it is a dictionary which you can pass either a `refresh_token` or an `access_token` values to revoke.

```python
oauth.rovokeaccess(access_token='access_token')
# or
oauth.rovokeaccess(refresh_token='refresh_token')
```

### OAuth2.refreshtokens(refresh_token,  secret='')

The refresh tokens avoids the user see the oauth consent screen everytime it needs to access the user account. The method creates a refresh token URL.

Arguments:
- refresh_token - User's refresh_token
- secret - client_secret (optional)

```python
oauth.refreshtokens('refresh_token')
```

# Challenge Class

The challenge module is meant for those who wants adhere to the Proof Key for Code Exchange ([PKFC](https://datatracker.ietf.org/doc/html/rfc7636)).

To import the module:
```python
from steer.oauth.challenge import S256
```
Google accepts two methods S256 and Plain, steer applies only to S256. You can implement the plain by inheriting the `IMethod` Class in the module.

To use the method is simple you pass the class as argument in the `oauth` instance.

```python
from steer.oauth.challenge import S256

oauth.create(S256())
```

# OAuth2Response Class
The class stores the mainly tokens after the code exchange step or when you are refreshing a token, also the class provides a method to check whether the access token is expired.

Attributes:
- access_token 
- refresh_token
- before_expires - when the access_token was issued
- expires_in - time in seconds
- when_expires - when the token validation ends 


Instance Arguments:
- res - It is the response given by google

```python
handle = OAuth2Response(res)
```

## OAuth2Response Methods
### OAuth2.is_expired()
This method checks if the token is expired.
```python
handle.is_expired()
```
The method result either return true or false.


# Drive
The drive package offers two classes `Upload` and `Update` that creates all the necessary efforts to create a URL to send to Google Drive to upload a file or update one. 

## Upload Class
The upload class is to create a upload request to the user's Google Drive, it supports two methods provided by Steer that is the simple media, and multipart media upload.

Instance Arguments:
A `data` argument is passed in the class instantiation which is a dictionary that contains the following keys:

```python
data = {
    "url": "the drive url",
    "params": {"url": "parameters"},
    "token": "access_token",
    "meta_data": "file's metadata",
    "file_path": "path/to/file"
}
```

If both meta data and file is provided **only** the file is upload if the user choose to use the simple upload media, to upload the metadata only make sure you remove the `file_path` key.

## Upload Methods

### Upload.simple(media = None)
The `simple` method upload only one thing at time whether is the file's metadata or file's data. 

Arguments:
- media - if not passed as argument in the instatiation, the method looks to the media argument to check if there are any, if not, then it means that the user does not provide any media type, hence the method throws an error.

```python
from steer.drive.upload import Upload
upload = Upload(data)
url = upload.simple({"name":"example.txt"})
```
The simple will create a URL in json format that Google uses. The method returns a dictionary with the following keys and values, the method returns the following keys when its uploading the metadata for a file:

```json
{
    "method": "POST",
    "url": "https://www.googleapis.com/drive/v3/files",
    "headers": {
        "Content-Type": "application/json",
        "Content-Lenght": "23"
    },
    "body": {
        "metadata": {
            "name": "example.txt"
        }
    },
    "full_url": "https://www.googleapis.com/drive/v3/files?uploadType=simple",
    "params": {
        "uploadType": "simple"
    }
}
```

### Upload.multipart(file = None, metadata = None)
The multipart is the method that uploads both metadata, and media. Specified by [RFC 2387](https://datatracker.ietf.org/doc/html/rfc2387), multipart/related is a type of request that creates an object made by compound ones, meaning that an object can contain multiple *distincts* parts that forms *only* one.

Google uses it, the file being the object and its compound being the metadata, and the file's data.

Arguments:
- file - location of the file in the system
- metadata - file's metadata

If one of the arguments is *not* provided the method returns an error.

```python
url = upload.multipart(file='./greetings.txt', 
           metadata={"name": "greetings.txt"}
           )
```

The returns of a multipart related content differs a bit from simple.

```json
{
    "method":"POST",
    "url":"https://www.googleapis.com/upload/drive/v3/files",
    "params":{
        "uploadType":"multipart"
    },
    "headers":{
        "top-level":{
            "Authorization":"Bearer access_token",
            "Content-Type":"multipart/related; boundary=file-actions",
            "Content-Length":"39"
        },
        "metadata":{
            "Content-Type":"application/json; charset=UTF-8"
        },
        "media":{
            "Content-Type":"text/plain"
        }
    },
    "body":{
        "data":"--file-actions\nContent-Type: application/json; charset=UTF-8\n\n{\"name\": \"greetings.txt\"}\n\n--file-actions\nContent-Type: text/plain\n\nHello, world!\n\n\n--file-actions--"
    },
    "full_url":"https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart"
}
```

The body request can be quite lengthy sometimes depending on the size of your file.

The headers of the return is divided in three layers the `top-level`, `metadata`, and `media`, it describes which headers was used to create the requests, sometimes could be useful to know.

### Update class
The update class inherits the upload class but the only different thing is that one use the PUT method instead of POST.
